<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>網頁MVP1017002</title>
  <link rel="preconnect" href="https://accounts.google.com"/>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --fg:#e5e7eb; --muted:#94a3b8;
      --accent:#22c55e; --danger:#ef4444; --blue:#38bdf8; --radius:14px;
      --border:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif}
    .app{
      display:grid;
      grid-template-columns:340px 1fr;
      gap:16px;
      align-items:start;
      padding:16px;
      min-height:100vh;
    }
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
    h2{margin:0 0 8px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input[type="text"], input[type="file"], textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--fg)}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);border:none;color:#052e1a;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#0b1220;color:var(--fg);border:1px solid var(--border)}
    .btn.danger{background:var(--danger);color:#2a0b0b}
    .stack{display:grid;gap:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .mini{font-size:12px;color:var(--muted)}
    /* 修改建議小欄位 */
    .suggest{
      width:100%;
      border:1px solid var(--border);
      background:#0b1220;
      color:var(--fg);
      border-radius:10px;
      padding:8px 10px;
      min-height:60px;
      resize:vertical;
      font-size:13px;
    }
    .suggest-label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:6px 0 4px;
    }



    /* 覆蓋 .log：固定高度 + 可滾動 */
.log{
  white-space:pre-wrap;
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  background:#0b1220;
  border-radius:10px;
  padding:10px;
  border:1px solid var(--border);
  min-height:140px;
  max-height:220px;         /* 新增：上限高度 */
  overflow:auto;            /* 新增：可滾動 */
}

/* 新增：任何需要成為滾動容器的區塊（舊作清單） */
.scroll{
  max-height:260px;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:10px;
}

/* 新增：按鈕忙碌樣式（操作時禁用 + 透明度） */
.btn.busy{
  opacity:.6;
  pointer-events:none;
}

/* 新增：按壓瞬間的微回饋（非必需，但更直覺） */
.btn:active{
  transform:translateY(1px);
}

    .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--border);color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;font-size:14px}
    .ok{color:#22c55e}
    .warn{color:#f59e0b}
    .err{color:#ef4444}
    .section{border:1px dashed var(--border);border-radius:12px;padding:12px}
    .section h3{margin:0 0 8px}
    .section .actions{display:flex;gap:8px;margin:6px 0 8px}
  </style>

  <!-- 讀 .docx -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <!-- 讀 .pdf -->
  <script src="https://unpkg.com/pdfjs-dist/build/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist/build/pdf.worker.min.js';
    }
  </script>
</head>
<body>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <div class="app">
    <!-- 左側：設定與上傳 -->
    <div class="card stack">
      <h2>① 基本設定</h2>
      <div class="stack">
        <div>
          <label>OpenAI API Key（只存在此頁記憶，不上傳）</label>
          <input id="openaiKey" type="password" placeholder="sk-..." />
          <div class="row"><span class="mini">建議先不要存 localStorage，頁面刷新即清空。</span></div>
        </div>
        <div class="grid2">
          <div>
            <label>Google OAuth Client ID（Web）</label>
            <input id="googleClientId" type="password" placeholder="xxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com" />
          </div>
          <div>
            <label>授權狀態</label>
            <div id="authStatus" class="badge">尚未登入</div>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="btnGoogleAuth">Google 登入授權</button>
          <button class="btn secondary" id="btnLogout">登出</button>
        </div>
        <!-- 本機儲存控制 -->
<div class="row">
  <button class="btn secondary" id="btnSaveLocal">儲存到本機</button>
  <button class="btn danger" id="btnClearLocal">清除本機憑證</button>
  <span class="mini">（儲存在此裝置的瀏覽器 localStorage）</span>
</div>

      </div>

      <h2>② 會議記錄</h2>
      <div class="stack">
        <input id="minutesFile" type="file" accept=".txt,.md,.docx,.pdf,.rtf,.json" />
        <button class="btn" id="btnParse">上傳並抽取關鍵資訊 → 解析</button>
        <textarea id="minutesPreview" placeholder="會議記錄摘要（自動產生，可手動修）"></textarea>
        <div class="grid2">
          <div>
            <label>作品名稱（ex. 洋基之子 / 共同好友）</label>
            <input id="workTitle" type="text" />
          </div>
          <div>
            <label>年度（ex. 2026）</label>
            <input id="workYear" type="text" />
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>場地</label>
            <input id="venue" type="text" />
          </div>
          <div>
            <label>檔期（日期區間或月份）</label>
            <input id="dates" type="text" />
          </div>
        </div>
        <div>
          <label>本輪調整重點（逗號分隔）</label>
          <input id="adjustments" type="text" placeholder="加強台語文本, 舞台改可拆組, 增列永續章節" />
        </div>
      </div>

      <div class="stack">
  <div class="row">
    <button class="btn secondary" id="btnScanOld">掃描舊作</button>
    <button class="btn secondary" id="btnApplyRename">套用建議命名</button>
  </div>

  <div class="row">
    <input id="oldSearch" type="text" placeholder="搜尋舊作（檔名或建議新檔名）" />
    <span class="mini">← 即時篩選（關鍵字）</span>
  </div>

  <div class="mini">規則：<code>【作品】_【年份】_【類型】_v01.ext</code>（例：<code>洋基之子_2024_劇本_v01.docx</code>）</div>

  <!-- 加上滾動外框 -->
  <div id="oldListWrap" class="scroll">
    <table class="table" id="renameTable">
      <thead>
        <tr><th>原檔名</th><th>建議新檔名</th><th>執行狀態</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
</div> <!-- ← 補這一行 -->


    <!-- 右側：流程與分段生成 -->
    <div class="card stack">
      <h2>④ 自動佈署＆生成／修訂／匯出</h2>
      <div class="row">
        <button class="btn" id="btnDeploy">建資料夾結構</button>
        <button class="btn secondary" id="btnWriteDoc">整合目前各段 → 寫入 Docs</button>
        <button class="btn secondary" id="btnExport">匯出 PDF → 存回 Drive</button>
      </div>

      <!-- 分段卡片 -->
      <div class="stack" id="sections">

        <!-- 緣起與目標 -->
        <div class="section" data-sec="originGoals">
          <h3>計畫緣起與目標</h3>
          <div class="mini">緣起（劇本主題＋會議記錄關鍵句約500字）｜計畫目標（3–5點，KR導向、可量化）</div>
          <div class="actions">
            <button class="btn" data-gen="originGoals">生成這一段</button>
            <button class="btn secondary" data-write="originGoals">寫入 Docs</button>
          </div>
          <label class="suggest-label">修改建議（不重寫，只微調；要整段重寫請輸入「重寫」）：</label>
          <textarea id="sug-originGoals" class="suggest" placeholder="例：避免空話、把量化指標放前面、加上在地合作脈絡"></textarea>

          <textarea id="sec-originGoals"></textarea>
        </div>

        <!-- 作品與內容說明 -->
        <div class="section" data-sec="workDescription">
          <h3>作品與內容說明</h3>
          <div class="mini">劇情簡介（150–250字）｜主題與議題（語言、身份、文化等）｜演出形式與特色（空間、聲景、物件、肢體、語言配置）</div>
          <div class="actions">
            <button class="btn" data-gen="workDescription">生成這一段</button>
            <button class="btn secondary" data-write="workDescription">寫入 Docs</button>
          </div>
          <label class="suggest-label">修改建議（不重寫，只微調；要整段重寫請輸入「重寫」）：</label>
          <textarea id="sug-workDescription" class="suggest" placeholder="例：聚焦角色動機、降低劇透、補上場景轉換節奏"></textarea>

          <textarea id="sec-workDescription"></textarea>
        </div>

        <!-- 創作與製作團隊 -->
        <div class="section" data-sec="team">
          <h3>創作與製作團隊</h3>
          <div class="mini">主要人員（表格：姓名｜職務｜簡介50–80字｜代表作）｜顧問與合作單位（若有）｜資料不足標示「待補」</div>
          <div class="actions">
            <button class="btn" data-gen="team">生成這一段</button>
            <button class="btn secondary" data-write="team">寫入 Docs</button>
          </div>
          <label class="suggest-label">修改建議（不重寫，只微調；要整段重寫請輸入「重寫」）：</label>
          <textarea id="sug-team" class="suggest" placeholder="例：補充各設計師代表作、標示（可能）人選、簡介精簡到80字內"></textarea>

          <textarea id="sec-team"></textarea>
        </div>

        <!-- 製作期程（甘特表） -->
        <div class="section" data-sec="schedule">
          <h3>製作期程（甘特表）</h3>
          <div class="mini">表格：年月｜項目｜說明｜負責人；多場地請分列版本</div>
          <div class="actions">
            <button class="btn" data-gen="schedule">生成這一段</button>
            <button class="btn secondary" data-write="schedule">寫入 Docs</button>
          </div>
          <label class="suggest-label">修改建議（不重寫，只微調；要整段重寫請輸入「重寫」）：</label>
          <textarea id="sug-schedule" class="suggest" placeholder="例：把宣傳前置拉早兩週、增加技測里程碑、區分A/B場地版本"></textarea>

          <textarea id="sec-schedule"></textarea>
        </div>

        <!-- 技術需求與舞台配置 -->
        <div class="section" data-sec="tech">
          <h3>技術需求與舞台配置</h3>
          <div class="mini">舞台／座位｜燈光／音響／投影／特需（多語字幕、台語比例）｜無障礙與共融（若未定列可行方案＋成本帶，無則免）</div>
          <div class="actions">
            <button class="btn" data-gen="tech">生成這一段</button>
            <button class="btn secondary" data-write="tech">寫入 Docs</button>
          </div>
          <label class="suggest-label">修改建議（不重寫，只微調；要整段重寫請輸入「重寫」）：</label>
          <textarea id="sug-tech" class="suggest" placeholder="例：加入字幕設備可行方案與成本帶、提高台語台詞比例、補輪椅席"></textarea>

          <textarea id="sec-tech"></textarea>
        </div>

        <!-- 行銷與票務策略 -->
        <div class="section" data-sec="marketing">
          <h3>行銷與票務策略</h3>
          <div class="mini">受眾分層與訊息主軸（3版 Slogan＋貼文骨架）｜通路與節點｜票務策略（票別／早鳥／套票／KPI）｜社群節奏表（週次｜素材｜CTA｜預期觸及／轉換）</div>
          <div class="actions">
            <button class="btn" data-gen="marketing">生成這一段</button>
            <button class="btn secondary" data-write="marketing">寫入 Docs</button>
          </div>
          <label class="suggest-label">修改建議（不重寫，只微調；要整段重寫請輸入「重寫」）：</label>
          <textarea id="sug-marketing" class="suggest" placeholder="例：加入台語社群KOL名單、提高早鳥比例、替換一組Slogan走生活感"></textarea>

          <textarea id="sec-marketing"></textarea>
        </div>

        <!-- 預算與資源配置 -->
        <div class="section" data-sec="budget">
          <h3>預算與資源配置（試算表）</h3>
          <div class="mini">表格：項目｜細目｜單價×數量｜小計｜備註；若有總預算／單項預算則代入，其餘標示「待補」</div>
          <div class="actions">
            <button class="btn" data-gen="budget">生成這一段</button>
            <button class="btn secondary" data-write="budget">寫入 Docs</button>
          </div>
          <label class="suggest-label">修改建議（不重寫，只微調；要整段重寫請輸入「重寫」）：</label>
          <textarea id="sug-budget" class="suggest" placeholder="例：把預備金改為8%、加入交通保險、宣傳改按分眾拉投放"></textarea>

          <textarea id="sec-budget"></textarea>
        </div>

      </div>

      <h2>⑤ 日誌</h2>
      <div id="log" class="log">準備就緒。</div>
    </div>

  </div>

<script>
// ======= 簡易狀態 =======
let accessToken = null;          // Google OAuth token
let tokenClient = null;          // GIS token client
let DRIVE_ROOT_NAME = '劇團AI測試';     // 根目錄
let CURRENT_DOC_ID = null;       // 目前生成的 Docs
let YEAR_FOLDER_ID = null;       // 年度資料夾 ID
let WORK_FOLDER_ID = null;       // 作品資料夾 ID
let DOCS_OUT_FOLDER_ID = null;   // 作品下「製作/計畫書」資料夾 ID（Docs/PDF 都存這）

// ★任務模板來源（優先讀 Sheet，找不到再讀 JSON）
const TASK_TEMPLATE_SHEET_NAME = '劇團計畫-任務模板';
const TASK_TEMPLATE_JSON_NAME  = '劇團計畫-任務模板.json';

// ★分段 Prompt 來源（改讀 Sheet）
const SECTION_PROMPT_SHEET_NAME = '劇團計畫-分段Prompts';

// === 舊作勾選與索引 ===
const SELECTED_OLD_FILE_IDS = new Set(); // 使用者勾選的舊作 fileId
const DRIVE_FILE_INDEX = {};             // id -> { id, name, mimeType }
let CURRENT_EXTRA_MINUTES = '';          // 單次生成時暫存的「舊作文字」


// 暫存每段結果（不放 localStorage）
const SECTIONS = {
  originGoals: '',
  workDescription: '',
  team: '',
  schedule: '',
  tech: '',
  marketing: '',
  budget: ''
};

// 推薦 Scopes：
const SCOPES = [
  // 讀取任意你有權限看的檔案內容（必要，否則會 403 appNotAuthorizedToFile）
  'https://www.googleapis.com/auth/drive.readonly',

  // 仍保留：可存取 App 自己建立的檔案（建立 Docs / 上傳 PDF 等）
  'https://www.googleapis.com/auth/drive.file',

  // 列出檔案必要的中繼資料
  'https://www.googleapis.com/auth/drive.metadata.readonly',

  // 操作 Google Docs（寫入內容）
  'https://www.googleapis.com/auth/documents',

    // ★新增：Google Tasks（建立清單與代辦）
  'https://www.googleapis.com/auth/tasks'

];


// Google API endpoints
const GDRIVE_FILES = 'https://www.googleapis.com/drive/v3/files';
const GDRIVE_UPLOAD = 'https://www.googleapis.com/upload/drive/v3/files';
const GDOCS = 'https://docs.googleapis.com/v1/documents';

const log = (msg, type='') => {
  const el = document.getElementById('log');
  const now = new Date().toLocaleTimeString();
  el.textContent += `\n[${now}] ${msg}`;
  el.scrollTop = el.scrollHeight;
}
function setAuthStatus(txt){ document.getElementById('authStatus').textContent = txt; }

// ======= 基礎純文字清理 & 截斷工具 =======
function sanitizeText(t){
  return (t||'')
    .replace(/[^\S\r\n]+/g, ' ')
    .replace(/[\u0000-\u0008\u000B-\u001F\u007F]/g, '')
    .replace(/\r\n/g, '\n')
    .trim();
}
function safeSliceForLLM(text, maxChars = 15000){
  const t = sanitizeText(text);
  return t.length > maxChars ? t.slice(0, maxChars) : t;
}

// ======= OAuth 登入 =======
function initGoogle(){
  const clientId = document.getElementById('googleClientId').value.trim();
  if(!clientId){ alert('請先填入 Google OAuth Client ID'); return; }
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: SCOPES.join(' '),
    callback: (resp)=>{
      if(resp && resp.access_token){
        accessToken = resp.access_token;
        setAuthStatus('已登入');
        log('Google OAuth 成功。');
      }else{
        log('Google OAuth 失敗。','err');
      }
    }
  });
  tokenClient.requestAccessToken({prompt: 'consent'});
}
function logout(){ accessToken = null; setAuthStatus('尚未登入'); log('已登出。'); }

// ======= 讀檔工具：支援 txt/md/docx/pdf（本機上傳用）=======
async function readFileAsText(file){
  const ext = (file.name.split('.').pop()||'').toLowerCase();
  const sizeMB = file.size / (1024*1024);
  if(sizeMB > 10) throw new Error('檔案過大（>10MB），請先精簡或分段。');

  // 純文字
  if(['txt','md','markdown','json'].includes(ext)){
    const text = await new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = reject;
      reader.readAsText(file);
    });
    return sanitizeText(text);
  }

  // Word（.docx）
  if(ext === 'docx'){
    const arrayBuffer = await new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
    const { value: html } = await window.mammoth.convertToHtml({ arrayBuffer });
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const paragraphs = Array.from(tmp.querySelectorAll('p, h1, h2, h3, h4, h5, h6'))
      .map(el => el.textContent.trim())
      .filter(Boolean);
    const text = paragraphs.join('\n\n');
    return sanitizeText(text);
  }

  // PDF（可擷取文字的 PDF）
  if(ext === 'pdf'){
    const arrayBuffer = await new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(reader.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const maxPages = Math.min(pdf.numPages, 150);
    let out = [];
    for(let p=1; p<=maxPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const line = content.items.map(it => it.str).join(' ');
      out.push(line);
      if(out.join('\n').length > 100000) break; // 安全上限
    }
    const text = out.join('\n\n').trim();
    if(!text) throw new Error('這份 PDF 沒內嵌可讀文字（可能是掃描影像）。請先用 OCR 轉成可搜尋文字的 PDF 或 .txt/.docx 再上傳。');
    return sanitizeText(text);
  }

  // 其他不支援（避免亂碼）
  throw new Error('目前支援：.txt/.md/.json/.docx/.pdf；其他格式請先轉檔。');
}

// ======= CSV 解析（支援引號與逗號）=======
function parseCSV(csvText, maxRows = 5000) {
  const rows = [];
  let row = [];
  let cur = '';
  let inQuotes = false;

  for (let i = 0; i < csvText.length; i++) {
    const ch = csvText[i];
    const next = csvText[i + 1];

    if (inQuotes) {
      if (ch === '"' && next === '"') { // 轉義引號 ""
        cur += '"';
        i++;
      } else if (ch === '"') {
        inQuotes = false;
      } else {
        cur += ch;
      }
    } else {
      if (ch === '"') {
        inQuotes = true;
      } else if (ch === ',') {
        row.push(cur);
        cur = '';
      } else if (ch === '\n') {
        row.push(cur);
        rows.push(row);
        cur = '';
        row = [];
        if (rows.length >= maxRows) break;
      } else if (ch !== '\r') {
        cur += ch;
      }
    }
  }
  if (cur.length || row.length) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

// ======= CSV → 文字摘要（控制長度，避免把整份表貼進 LLM）=======
function summarizeCsvToText(csvText, {sampleRows = 60, sampleCols = 12} = {}) {
  const rows = parseCSV(csvText, sampleRows + 1);
  if (!rows.length) return '';

  const headers = rows[0].map(h => (h || '').trim()).slice(0, sampleCols);
  const data = rows.slice(1).map(r =>
    headers.reduce((o, h, idx) => {
      o[h || `col${idx+1}`] = (r[idx] || '').trim();
      return o;
    }, {})
  );

  const approxRows = rows.length;
  const colCount = headers.length;

  const sample = data.slice(0, sampleRows).map(obj=>{
    const trimmed = {};
    for(const k of Object.keys(obj)) {
      const v = obj[k] || '';
      trimmed[k] = v.length > 80 ? (v.slice(0,80) + '…') : v;
    }
    return JSON.stringify(trimmed);
  });

  return [
    '[Google Sheet 摘要]',
    `欄數：${colCount}｜（抽樣）列數：約 ${approxRows - 1}`,
    `欄位：${headers.join(' | ')}`,
    '樣本（JSON Lines；僅前幾列）：',
    ...sample
  ].join('\n');
}

// ★把 Google Sheet (CSV 匯出) 轉成任務陣列
async function loadTaskTemplatesFromSheet(ctx) {
  const f = await findFileByExactName(TASK_TEMPLATE_SHEET_NAME);
  if (!f) return null;
  if (f.mimeType !== 'application/vnd.google-apps.spreadsheet') return null;

  // 匯出 CSV
  const res = await gfetch(`${GDRIVE_FILES}/${f.id}/export?mimeType=text/csv&supportsAllDrives=true`);
  const csv = await res.text();
  const rows = parseCSV(csv);
  if (!rows.length) return [];

  const headers = rows[0].map(h => (h || '').trim());
  const idx = (name) => headers.findIndex(h => h.toLowerCase() === name.toLowerCase());

  const iEnabled = idx('enabled');
  const iTitle = idx('title');
  const iNotes = idx('notes');
  const iDue = idx('due_offset_days');
  const iList = idx('list_name');
  const iL1T = idx('link1_text');
  const iL1U = idx('link1_url');
  const iL2T = idx('link2_text');
  const iL2U = idx('link2_url');

  const tReplace = (s='') => s
    .replaceAll('{{title}}', ctx.title || '')
    .replaceAll('{{year}}', ctx.year || '')
    .replaceAll('{{workFolderUrl}}', ctx.workFolderUrl || '')
    .replaceAll('{{planFolderUrl}}', ctx.planFolderUrl || '')
    .replaceAll('{{planDocUrl}}', ctx.planDocUrl || '');

  const out = [];
  rows.slice(1).forEach(r => {
    const enabled = ((r[iEnabled] || '').toString().toLowerCase().trim() === 'true');
    if (!enabled) return;

    const t = tReplace(r[iTitle] || '');
    const n = tReplace(r[iNotes] || '');
    const dueOffset = parseInt((r[iDue] || '0').trim(), 10) || 0;
    const listName = (r[iList] || '').trim(); // 先保留（等下會強制覆寫成「年度,作品」）

    const links = [];
    const l1t = tReplace(r[iL1T] || ''), l1u = tReplace(r[iL1U] || '');
    const l2t = tReplace(r[iL2T] || ''), l2u = tReplace(r[iL2U] || '');
    if (l1t && l1u) links.push({ type: 'link', description: l1t, link: l1u });
    if (l2t && l2u) links.push({ type: 'link', description: l2t, link: l2u });

    const d = new Date(); d.setDate(d.getDate() + dueOffset);
    const dueISODate = d.toISOString().slice(0,10); // YYYY-MM-DD

    out.push({ title: t, notes: n, dueISODate, links, listName });
  });

  return out;
}

// ★後備：讀 Drive 上 JSON 檔 → 任務陣列
async function loadTaskTemplatesFromJson(ctx) {
  const f = await findFileByExactName(TASK_TEMPLATE_JSON_NAME);
  if (!f) return null;
  const blobRes = await gfetch(`${GDRIVE_FILES}/${f.id}?alt=media&supportsAllDrives=true`);
  const txt = await blobRes.text();
  let arr = [];
  try { arr = JSON.parse(txt); } catch { return []; }

  const tReplace = (s='') => s
    .replaceAll('{{title}}', ctx.title || '')
    .replaceAll('{{year}}', ctx.year || '')
    .replaceAll('{{workFolderUrl}}', ctx.workFolderUrl || '')
    .replaceAll('{{planFolderUrl}}', ctx.planFolderUrl || '')
    .replaceAll('{{planDocUrl}}', ctx.planDocUrl || '');
;

  return (arr || [])
    .filter(x => String(x.enabled).toLowerCase() === 'true')
    .map(x => {
      const dueOffset = parseInt((x.due_offset_days ?? 0), 10) || 0;
      const d = new Date(); d.setDate(d.getDate() + dueOffset);
      const dueISODate = d.toISOString().slice(0,10);
      const links = Array.isArray(x.links) ? x.links.map(l => ({
        type: 'link',
        description: tReplace(l.description || ''),
        link: tReplace(l.link || '')
      })) : [];
      return {
        title: tReplace(x.title || ''),
        notes: tReplace(x.notes || ''),
        dueISODate,
        links,
        listName: (x.list_name || '')
      };
    });
}

// ★統一入口：先讀 Sheet，沒有再讀 JSON
async function loadTaskTemplates(ctx) {
  const fromSheet = await loadTaskTemplatesFromSheet(ctx);
  if (fromSheet && fromSheet.length !== null) return fromSheet;
  const fromJson = await loadTaskTemplatesFromJson(ctx);
  return fromJson || [];
}



// ======= 讀取 Blob → 文字（Drive 下載用；支援 txt/md/json/docx/pdf）=======
async function readBlobAsText(blob, filename = 'file', mimeType = '') {
  const ext = (filename.split('.').pop() || '').toLowerCase();
  const type = (mimeType || blob.type || '').toLowerCase();

  if (['txt','md','markdown','json'].includes(ext) || type.startsWith('text/')) {
    return sanitizeText(await blob.text());
  }

  if (ext === 'docx' || type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
    const arrayBuffer = await blob.arrayBuffer();
    const { value: html } = await window.mammoth.convertToHtml({ arrayBuffer });
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const paragraphs = Array.from(tmp.querySelectorAll('p, h1, h2, h3, h4, h5, h6'))
      .map(el => el.textContent.trim())
      .filter(Boolean);
    return sanitizeText(paragraphs.join('\n\n'));
  }

  if (ext === 'pdf' || type === 'application/pdf') {
    const arrayBuffer = await blob.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    const maxPages = Math.min(pdf.numPages, 150);
    let out = [];
    for (let p = 1; p <= maxPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      out.push(content.items.map(it => it.str).join(' '));
      if (out.join('\n').length > 100000) break;
    }
    const text = out.join('\n\n').trim();
    if (!text) throw new Error(`PDF 無可讀文字：${filename}`);
    return sanitizeText(text);
  }

  return '';
}

// ======= 從 Google Drive 抓檔並轉成純文字（含 Shortcut/Docs/Sheet/Slides/一般檔）=======
async function fetchDriveFileText(fileId) {
  if (!accessToken) throw new Error('尚未取得 Google Access Token');

  // 先取索引中的基本資料；若沒有就打一次 metadata（加 supportsAllDrives）
  let meta = DRIVE_FILE_INDEX[fileId];
  if (!meta) {
    const res = await gfetch(`${GDRIVE_FILES}/${fileId}?fields=id,name,mimeType,shortcutDetails(targetId,targetMimeType)&supportsAllDrives=true`);
    meta = await res.json();
  }

  // 解捷徑：指向真正目標
  let effId = meta.id;
  let effMime = meta.mimeType || '';
  let effName = meta.name || '';

  if (effMime === 'application/vnd.google-apps.shortcut') {
    const sd = meta.shortcutDetails;
    if (!sd || !sd.targetId) {
      log(`捷徑缺少目標資訊：${effName}`, 'warn');
      return '';
    }
    effId = sd.targetId;
    effMime = sd.targetMimeType || '';

    // 再補一次目標名稱（可選）
    try {
      const tRes = await gfetch(`${GDRIVE_FILES}/${effId}?fields=id,name,mimeType&supportsAllDrives=true`);
      const tMeta = await tRes.json();
      effName = tMeta.name || effName;
      effMime = tMeta.mimeType || effMime;
    } catch {}
  }

  // Google Docs → 純文字匯出
  if (effMime === 'application/vnd.google-apps.document') {
    const res = await gfetch(`${GDRIVE_FILES}/${effId}/export?mimeType=text/plain&supportsAllDrives=true`);
    const txt = await res.text();
    return sanitizeText(txt);
  }

  // Google Sheets → 匯出 CSV → 摘要
  if (effMime === 'application/vnd.google-apps.spreadsheet') {
    const res = await gfetch(`${GDRIVE_FILES}/${effId}/export?mimeType=text/csv&supportsAllDrives=true`);
    const csv = await res.text();
    const summary = summarizeCsvToText(csv, { sampleRows: 60, sampleCols: 12 });
    return sanitizeText(summary);
  }

  // Google Slides → 匯出 PDF → 轉文字（pdfjs）
  if (effMime === 'application/vnd.google-apps.presentation') {
    const res = await gfetch(`${GDRIVE_FILES}/${effId}/export?mimeType=application/pdf&supportsAllDrives=true`);
    const pdfBlob = await res.blob();
    return await readBlobAsText(pdfBlob, effName + '.pdf', 'application/pdf');
  }

  // 其他 Google 檔（如 Drawings）暫不支援
  if (effMime.startsWith('application/vnd.google-apps.')) {
    log(`尚未支援的 Google 檔類型：${effMime}（${effName}）`, 'warn');
    return '';
  }

  // 一般上傳檔（docx/pdf/txt/md/json…）→ alt=media 下載
  const blobRes = await gfetch(`${GDRIVE_FILES}/${effId}?alt=media&supportsAllDrives=true`);
  const blob = await blobRes.blob();
  return await readBlobAsText(blob, effName, effMime);
}



// ======= 收集使用者勾選的舊作文字，做長度上限裁切（全域可用）=======
async function gatherSelectedOldTexts(maxChars = 15000) {
  if (!SELECTED_OLD_FILE_IDS.size) return '';
  let chunks = [];
  let picked = [];

  for (const id of SELECTED_OLD_FILE_IDS) {
    try {
      const t = await fetchDriveFileText(id);
      if (t) {
        chunks.push(t);
        picked.push(DRIVE_FILE_INDEX[id]?.name || id);
      }
    } catch (e) {
      log(`讀取舊作失敗（${id}）：${e.message}`, 'err');
    }
    const joined = chunks.join('\n\n');
    if (joined.length > maxChars) break;
  }

  if (picked.length) log(`已併入舊作：${picked.join('、')}`);

  return safeSliceForLLM(chunks.join('\n\n'), maxChars);
}


// ======= OpenAI 基本呼叫（含詳細錯誤日誌） =======
async function openaiChat(messages, {json=false, temperature=0.3}={}) {
  const key = document.getElementById('openaiKey').value.trim();
  if(!key) throw new Error('請先填入 OpenAI Key');

  // <<< 這裡改成你的 Workers URL >>>
  const PROXY_URL = 'https://script.google.com/macros/s/AKfycbzbZ5qy-_Fy7-BJJBKR0LE7w3xjxPbDBK9ipkyzMtGSR18FaeQrluFvZx6aRwUlFYLP/exec';

  const body = {
    // 使用者的 key 放在 body，由 Proxy 代叫 OpenAI
    key,
    model: 'gpt-4o-mini',
    messages,
    temperature,
    ...(json ? { response_format: { type: 'json_object' } } : {})
  };

  let res;
  try {
    res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
      body: JSON.stringify(body)
    });
  } catch (networkErr) {
    log('無法連線到 Proxy：' + (networkErr?.message || networkErr), 'err');
    throw new Error('無法連線到 Proxy（網路或外掛阻擋）。');
  }

  let j = {};
  try { j = await res.json(); } catch {}

  if (!res.ok) {
    const msg = j?.error?.message || JSON.stringify(j);
    log(`Proxy/OpenAI 錯誤（${res.status}）：${msg}`, 'err');
    throw new Error(`Proxy/OpenAI 呼叫失敗（${res.status}）：${msg}`);
  }

  const content = j.choices?.[0]?.message?.content;
  if (!content) throw new Error('OpenAI 回應為空');
  return content;
}

function shouldRewrite(sug=''){
  const s = (sug||'').toLowerCase();
  return /(重寫|重新寫|rewrite|from scratch|重新來|整段重做)/.test(s);
}

// 依「舊內容 + 修改建議」做精修（非重寫）
async function reviseSection(secKey, oldText, suggestion){
  const ctx = buildCommonContext();
  const sys = `你是一位中文計劃書編輯。除非使用者明確指示「重寫」，否則「只在既有內容上」做最小必要變動，保持原段落結構與資訊密度，不新增未經確認的資料。輸出純文字（可含原有 Markdown 表格），不要加任何說明。`;
  const ask = `
請根據「修改建議」微調下列內容；能局部改就絕不整段重寫，保留原用語風格與資訊結構：

【段落類型】${secKey}
【已有內容】
${oldText}

【修改建議】
${suggestion}

【可引用之背景（會議記錄精簡）】
${(ctx.minutes||'').slice(0,1200)}
  `.trim();

  const out = await openaiChat([
    {role:'system',content:sys},
    {role:'user',content:ask}
  ],{temperature:0.25});
  return out;
}


// ======= 從會議記錄抽取欄位 =======
async function extractFromMinutes(raw){
  const snippet = safeSliceForLLM(raw, 15000); // 只送前 15k 字
  const sys = `你是一個會議記錄抽取助手。從輸入文字抽取：year、title、venue、dates（字串）、adjustments（陣列），皆為繁體中文。若無請留空或給空陣列。輸出必須是純 JSON 物件，不得包含多餘文字或註解。`;
  const prompt = `會議記錄如下（節錄）：\n\n${snippet}`;
  const content = await openaiChat([
    {role:'system', content:sys},
    {role:'user', content:prompt}
  ],{json:true, temperature:0.2});

  // 防禦性清理 fenced code
  let clean = content.trim();
  clean = clean.replace(/^```json\s*/i,'').replace(/```$/,'').trim();
  try{
    return JSON.parse(clean);
  }catch(e){
    throw new Error('解析抽取結果失敗：回傳並非有效 JSON。原始內容片段：\n' + clean.slice(0,500));
  }
}

// ======= 從 Google Sheet 讀各分段的 System / Prompt（CSV 匯出）=======
const PROMPT_CACHE = {}; // key -> { system, prompt, temperature }

function tReplaceBase(s = '', ctx = {}) {
  // 基本變數替換
  return (s || '')
    .replaceAll('{{jsonCtx}}', JSON.stringify(ctx, null, 2))
    .replaceAll('{{minutes}}', (ctx.minutes || '').slice(0, 2000));
}
function applySuggestionBlocks(s = '', suggestion = '') {
  // 讓 {{#suggestion}}...{{/suggestion}} 只有在有建議時出現
  if (!suggestion) {
    return s.replace(/{{#suggestion}}[\s\S]*?{{\/suggestion}}/g, '').replaceAll('{{suggestion}}','');
  }
  return s.replaceAll('{{#suggestion}}', '').replaceAll('{{/suggestion}}', '').replaceAll('{{suggestion}}', suggestion);
}

async function loadSectionPromptsFromSheet() {
  if (Object.keys(PROMPT_CACHE).length) return PROMPT_CACHE; // 已載過
  const f = await findFileByExactName(SECTION_PROMPT_SHEET_NAME);
  if (!f || f.mimeType !== 'application/vnd.google-apps.spreadsheet') {
    log(`找不到 Sheet「${SECTION_PROMPT_SHEET_NAME}」，將使用函式內建的預設提示詞。`, 'warn');
    return PROMPT_CACHE; // 空表示沒載到
  }
  const res = await gfetch(`${GDRIVE_FILES}/${f.id}/export?mimeType=text/csv&supportsAllDrives=true`);
  const csv = await res.text();
  const rows = parseCSV(csv);
  if (!rows.length) return PROMPT_CACHE;

  const headers = rows[0].map(h => (h || '').trim().toLowerCase());
  const idx = n => headers.findIndex(h => h === n);

  const ikey = idx('key');
  const isys = idx('system');
  const ipmt = idx('prompt');
  const itmp = idx('temperature');

  rows.slice(1).forEach(r => {
    const key = (r[ikey] || '').trim();
    if (!key) return;
    PROMPT_CACHE[key] = {
      system: (r[isys] || '').trim(),
      prompt: (r[ipmt] || '').trim(),
      temperature: parseFloat((r[itmp] || '').trim()) || 0.35
    };
  });
  log(`已載入分段 Prompts（${Object.keys(PROMPT_CACHE).length} 筆）。`);
  return PROMPT_CACHE;
}

async function getSectionPrompt(secKey, ctx, opts = {}) {
  await loadSectionPromptsFromSheet(); // 嘗試載入（快取保護）
  const rec = PROMPT_CACHE[secKey] || {};

  // 預設 system / prompt（若 Sheet 沒給）
  let sys = rec.system || '你是中文計畫書編輯，輸出繁體中文，避免虛構，語氣精準。';
  let pmt = rec.prompt || `請根據以下資訊撰寫段落（${secKey}）。已知欄位：{{jsonCtx}}。會議重點：{{minutes}}
{{#suggestion}}【修改建議】\n{{suggestion}}{{/suggestion}}`;

  // 變數替換
  pmt = tReplaceBase(pmt, ctx);
  pmt = applySuggestionBlocks(pmt, (opts?.suggestion || ''));

  return {
    sys,
    prompt: pmt,
    temperature: rec.temperature || 0.35
  };
}


// ======= 產生各段內容的提示詞 =======
function buildCommonContext(){
  const year = document.getElementById('workYear').value.trim();
  const title = document.getElementById('workTitle').value.trim();
  const venue = document.getElementById('venue').value.trim();
  const dates = document.getElementById('dates').value.trim();
  const adjustments = document.getElementById('adjustments').value.split(',').map(s=>s.trim()).filter(Boolean);
  const minutesRaw = document.getElementById('minutesPreview').value.trim();
  const minutesCombined = [minutesRaw, CURRENT_EXTRA_MINUTES].filter(Boolean).join('\n\n');
  return {year,title,venue,dates,adjustments,minutes: minutesCombined};
}



async function gen_originGoals(opts = {}) {
  const ctx = buildCommonContext();
  const { sys, prompt, temperature } = await getSectionPrompt('originGoals', ctx, opts);
  return await openaiChat(
    [{ role: 'system', content: sys }, { role: 'user', content: prompt }],
    { temperature }
  );
}


async function gen_workDescription(opts = {}) {
  const ctx = buildCommonContext();
  const { sys, prompt, temperature } = await getSectionPrompt('workDescription', ctx, opts);
  return await openaiChat(
    [{ role: 'system', content: sys }, { role: 'user', content: prompt }],
    { temperature }
  );
}


async function gen_team(opts = {}) {
  const ctx = buildCommonContext();
  const { sys, prompt, temperature } = await getSectionPrompt('team', ctx, opts);
  return await openaiChat(
    [{ role: 'system', content: sys }, { role: 'user', content: prompt }],
    { temperature }
  );
}


async function gen_schedule(opts = {}) {
  const ctx = buildCommonContext();
  const { sys, prompt, temperature } = await getSectionPrompt('schedule', ctx, opts);
  return await openaiChat(
    [{ role: 'system', content: sys }, { role: 'user', content: prompt }],
    { temperature }
  );
}

async function gen_tech(opts = {}) {
  const ctx = buildCommonContext();
  const { sys, prompt, temperature } = await getSectionPrompt('tech', ctx, opts);
  return await openaiChat(
    [{ role: 'system', content: sys }, { role: 'user', content: prompt }],
    { temperature }
  );
}


async function gen_marketing(opts = {}) {
  const ctx = buildCommonContext();
  const { sys, prompt, temperature } = await getSectionPrompt('marketing', ctx, opts);
  return await openaiChat(
    [{ role: 'system', content: sys }, { role: 'user', content: prompt }],
    { temperature }
  );
}

async function gen_budget(opts = {}) {
  const ctx = buildCommonContext();
  const { sys, prompt, temperature } = await getSectionPrompt('budget', ctx, opts);
  return await openaiChat(
    [{ role: 'system', content: sys }, { role: 'user', content: prompt }],
    { temperature }
  );
}


// ======= Drive 基本操作 =======
async function gfetch(url, opts={}){
  if(!accessToken) throw new Error('尚未取得 Google Access Token');
  const res = await fetch(url, {
    ...opts,
    headers:{
      'Authorization': `Bearer ${accessToken}`,
      ...(opts.headers||{})
    }
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error('Google API 錯誤：'+t);
  }
  return res;
}
async function findFolderByName(name, parentId){
  const q = encodeURIComponent(`name = '${name}' and mimeType = 'application/vnd.google-apps.folder' and '${parentId||'root'}' in parents and trashed=false`);
  const res = await gfetch(`${GDRIVE_FILES}?q=${q}&fields=files(id,name)`);
  const j = await res.json();
  return j.files?.[0] || null;
}

// =================== Google Tasks：清單與代辦 ===================
const GTASKS_BASE = 'https://tasks.googleapis.com/tasks/v1';

// 共用 fetch（和 gfetch 一樣帶 token）
async function tfetch(url, opts={}) {
  if (!accessToken) throw new Error('尚未取得 Google Access Token');
  const res = await fetch(url, {
    ...opts,
    headers: { 'Authorization': `Bearer ${accessToken}`, ...(opts.headers||{}) }
  });
  if (!res.ok) {
    const t = await res.text();
    throw new Error('Google Tasks API 錯誤：' + t);
  }
  return res;
}

// 取得或建立「年度,作品名稱」專屬清單（例：2026,洋基之子）
async function findOrCreateTaskList(listName) {
  // 先列出全部清單找有沒有同名
  const res = await tfetch(`${GTASKS_BASE}/users/@me/lists?maxResults=200`);
  const j = await res.json();
  const hit = (j.items || []).find(x => x.title === listName);
  if (hit) return hit;

  // 建立
  const createRes = await tfetch(`${GTASKS_BASE}/users/@me/lists`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title: listName })
  });
  return await createRes.json();
}

// 建立單一 task
async function createTask(taskListId, { title, notes, dueISODate, links }) {
  const due = dueISODate ? `${dueISODate}T00:00:00.000Z` : undefined;
  const body = { title: title || '(未命名)', notes: notes || undefined, due };

  if (Array.isArray(links) && links.length) {
    // Google Tasks v1 支援 links: [{type:'link', description:'...', link:'...'}]
    body.links = links.map(l => ({
      type: l.type || 'link',
      description: l.description || '',
      link: l.link || ''
    }));
  }

  const res = await tfetch(`${GTASKS_BASE}/lists/${encodeURIComponent(taskListId)}/tasks`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return await res.json();
}


// 批次建立（分批避免節流）
async function createManyTasks({ listName, tasks, chunkSize = 25, delayMs = 200 }) {
  const list = await findOrCreateTaskList(listName);
  const created = [];
  const failed = [];

  for (let i = 0; i < tasks.length; i++) {
    const t = tasks[i];
    try {
      const one = await createTask(list.id, t);
      created.push(one);
    } catch (e) {
      failed.push({ input: t, error: e.message });
    }
    // 節流：每 chunkSize 筆停一下
    if ((i + 1) % chunkSize === 0) {
      await new Promise(r => setTimeout(r, delayMs));
    }
  }
  return { list, created, failed };
}


// ★依「檔名完全相同」找一個檔（不限資料夾）
async function findFileByExactName(name) {
  const q = encodeURIComponent(`name = '${name}' and trashed=false`);
  const url = `${GDRIVE_FILES}?q=${q}`
    + `&fields=files(id,name,mimeType)`
    + `&includeItemsFromAllDrives=true&supportsAllDrives=true`;
  const res = await gfetch(url);
  const j = await res.json();
  return j.files?.[0] || null;
}


async function createFolder(name, parentId){
  const meta = { name, mimeType: 'application/vnd.google-apps.folder', parents: parentId ? [parentId] : undefined };
  const res = await gfetch(GDRIVE_FILES,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(meta) });
  return await res.json();
}
async function findOrCreateFolder(name, parentId){
  let f = await findFolderByName(name, parentId);
  if(f) return f;
  return await createFolder(name, parentId);
}
async function listFilesByKeyword(keyword){
  const q = encodeURIComponent(`name contains '${keyword}' and trashed=false`);
  const url = `${GDRIVE_FILES}?q=${q}`
    + `&fields=files(id,name,mimeType,parents,shortcutDetails(targetId,targetMimeType))`
    + `&includeItemsFromAllDrives=true&supportsAllDrives=true`;
  const res = await gfetch(url);
  return await res.json();
}

// 取得文件目前的 endIndex（最後一個元素的 endIndex）
async function getDocEndIndex(docId){
  const res = await gfetch(`${GDOCS}/${docId}`);
  const doc = await res.json();

  // body.content 通常最後一個元素的 endIndex 就是整份文件的結尾
  const content = doc?.body?.content || [];
  if (!content.length) return 1;

  const last = content[content.length - 1];
  const endIndex = (typeof last.endIndex === 'number') ? last.endIndex : 1;
  return endIndex || 1;
}

// ======= 建立作品資料夾樹狀結構（依需求）=======
async function ensureFolderTree(rootId, yearStr, workTitle){
  // 年度
  const yearFolder = await findOrCreateFolder(yearStr, rootId);
  YEAR_FOLDER_ID = yearFolder.id;

  // 作品
  const workFolder = await findOrCreateFolder(workTitle, YEAR_FOLDER_ID);
  WORK_FOLDER_ID = workFolder.id;

  // 第三層：製作 / 共用資料夾
  const prodFolder     = await findOrCreateFolder('製作', WORK_FOLDER_ID);
  const sharedFolder   = await findOrCreateFolder('共用資料夾', WORK_FOLDER_ID);

  // 製作底下
  const planFolder     = await findOrCreateFolder('計畫書', prodFolder.id);
  await findOrCreateFolder('製作會議記錄', prodFolder.id);

  const grantFolder    = await findOrCreateFolder('補助', prodFolder.id);
  await findOrCreateFolder('文化局', grantFolder.id);
  await findOrCreateFolder('國藝會', grantFolder.id);
  await findOrCreateFolder('文化部', grantFolder.id);
  await findOrCreateFolder('其他',   grantFolder.id);

  const financeFolder  = await findOrCreateFolder('財務', prodFolder.id);
  await findOrCreateFolder('發票', financeFolder.id);

  await findOrCreateFolder('宣傳', prodFolder.id);
  await findOrCreateFolder('售票', prodFolder.id);
  await findOrCreateFolder('觀眾回饋', prodFolder.id);

  const closeoutFolder = await findOrCreateFolder('結案', prodFolder.id);
  await findOrCreateFolder('文化局', closeoutFolder.id);
  await findOrCreateFolder('國藝會', closeoutFolder.id);
  await findOrCreateFolder('文化部', closeoutFolder.id);
  await findOrCreateFolder('其他',   closeoutFolder.id);

  // 共用資料夾底下
  await findOrCreateFolder('劇本', sharedFolder.id);
  await findOrCreateFolder('排練紀錄', sharedFolder.id);
  await findOrCreateFolder('會議記錄', sharedFolder.id);

  const techFolder = await findOrCreateFolder('技術資料', sharedFolder.id);
  await findOrCreateFolder('燈光', techFolder.id);
  await findOrCreateFolder('舞台', techFolder.id);
  await findOrCreateFolder('音樂/音效', techFolder.id);
  await findOrCreateFolder('影像', techFolder.id);
  await findOrCreateFolder('舞監', techFolder.id);
  await findOrCreateFolder('舊作資料', techFolder.id); // 只建立資料夾，不匯入任何捷徑

  const recordFolder = await findOrCreateFolder('演出紀錄', sharedFolder.id);
  await findOrCreateFolder('靜態', recordFolder.id);
  await findOrCreateFolder('動態', recordFolder.id);

  await findOrCreateFolder('場館資料', sharedFolder.id);
  await findOrCreateFolder('時程', sharedFolder.id);

  // 讓其它程式知道「計畫書」在哪裡
  DOCS_OUT_FOLDER_ID = planFolder.id;

  return { yearFolderId: YEAR_FOLDER_ID, workFolderId: WORK_FOLDER_ID, planFolderId: DOCS_OUT_FOLDER_ID };
}



// ======= Docs 建立與覆寫 =======
async function createDoc(title){
  const res = await gfetch(GDOCS,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({title}) });
  const doc = await res.json();
  // 存到 作品/製作/計畫書
  const parentId = DOCS_OUT_FOLDER_ID || WORK_FOLDER_ID || 'root';
  await gfetch(`${GDRIVE_FILES}/${doc.documentId}?addParents=${parentId}&removeParents=root&fields=id,parents&supportsAllDrives=true`, { method:'PATCH' });
  return doc.documentId;
}

async function overwriteDoc(docId, content){
  // 1) 先抓文件實際 endIndex
  const endIndex = await getDocEndIndex(docId);

  // 2) 組 requests：
  //    - 文件長度 > 2 才刪除（避免空範圍）
  //    - 再在 index:1 插入新文字
  const requests = [];

  if (endIndex > 2) {
    requests.push({
      deleteContentRange: {
        range: {
          segmentId: null,
          startIndex: 1,
          endIndex: endIndex - 1 // endIndex 為排他；刪到最後一個內容前即可
        }
      }
    });
  }

  // 確保最後有斷行
  const textToInsert = content?.endsWith('\n') ? content : (content + '\n');

  requests.push({
    insertText: {
      location: { index: 1 },
      text: textToInsert
    }
  });

  await gfetch(`${GDOCS}/${docId}:batchUpdate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ requests })
  });
}

// ======= 匯出 PDF 並存回 Drive =======
async function exportDocToPdfAndSave(docId, outName){
  const exportRes = await gfetch(`${GDRIVE_FILES}/${docId}/export?mimeType=application/pdf`);
  const blob = await exportRes.blob();
  const parentId = DOCS_OUT_FOLDER_ID || WORK_FOLDER_ID || 'root'; // 製作/計畫書
  const meta = { name: outName || '計劃書輸出.pdf', parents:[parentId] };
  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(meta)],{type:'application/json'}));
  form.append('file', blob);
  const res = await fetch(`${GDRIVE_UPLOAD}?uploadType=multipart`,{ method:'POST', headers:{'Authorization': `Bearer ${accessToken}`}, body: form });
  if(!res.ok){ const t = await res.text(); throw new Error('上傳 PDF 失敗：'+t); }
  const j = await res.json();
  return j.id;
}


// ======= 將各段合成完整文件骨架（未生成者顯示「待補」） =======
function buildFullDoc(){
  const year = document.getElementById('workYear').value.trim();
  const title = document.getElementById('workTitle').value.trim();
  const venue = document.getElementById('venue').value.trim();
  const dates = document.getElementById('dates').value.trim();
  const adjustments = document.getElementById('adjustments').value.split(',').map(s=>s.trim()).filter(Boolean).join('、');

  const sec = (k, heading)=> `## ${heading}\n${(SECTIONS[k]||'(待補)')}\n\n`;

  return (
`# ${title || '（未命名）'}（${year || 'YYYY'}）計劃書

**場地**：${venue||''}  
**檔期**：${dates||''}  
**本輪調整重點**：${adjustments||''}

${sec('originGoals','計畫緣起與目標')}
${sec('workDescription','作品與內容說明')}
${sec('team','創作與製作團隊')}
${sec('schedule','製作期程（甘特表）')}
${sec('tech','技術需求與舞台配置')}
${sec('marketing','行銷與票務策略')}
${sec('budget','預算與資源配置（試算表）')}
`
  );
}


function filterOldList(){
  const q = (document.getElementById('oldSearch')?.value || '').trim().toLowerCase();
  const rows = document.querySelectorAll('#renameTable tbody tr');
  rows.forEach(r=>{
    const name = r.querySelector('td:first-child span:nth-of-type(1)')?.textContent.toLowerCase() || '';
    const sugg = r.querySelector('td:nth-child(2) input')?.value.toLowerCase() || '';
    r.style.display = (q==='' || name.includes(q) || sugg.includes(q)) ? '' : 'none';
  });
}

// 初始掛上 input 事件（DOM 皆已存在時會成功；若先載入也無妨）
document.addEventListener('DOMContentLoaded', ()=>{
  const s = document.getElementById('oldSearch');
  if(s) s.addEventListener('input', filterOldList);
  // 開頁自動從本機載入
loadLocalSecrets();

// 綁定「儲存到本機」與「清除本機憑證」按鈕
document.getElementById('btnSaveLocal')?.addEventListener('click', saveLocalSecrets);
document.getElementById('btnClearLocal')?.addEventListener('click', clearLocalSecrets);

});



// ======= 事件繫結：登入/登出/解析/命名/佈署/生成/寫入/匯出 =======
document.getElementById('btnGoogleAuth').addEventListener('click', ()=> initGoogle());
document.getElementById('btnLogout').addEventListener('click', ()=> logout());

document.getElementById('btnParse').addEventListener('click', async ()=>{
  try{
    const f = document.getElementById('minutesFile').files?.[0];
    if(!f) return alert('請選擇會議記錄檔（建議 .txt/.md，亦支援 .docx/.pdf）');
    log(`讀取會議記錄（${f.name}）…`);
    const raw = await readFileAsText(f);
    const preview = safeSliceForLLM(raw, 5000);
    document.getElementById('minutesPreview').value = preview;

    const ext = await extractFromMinutes(raw);
    log('抽取完成：'+JSON.stringify(ext));
    if(ext.title) document.getElementById('workTitle').value = ext.title;
    if(ext.year) document.getElementById('workYear').value = ext.year;
    if(ext.venue) document.getElementById('venue').value = ext.venue;
    if(ext.dates) document.getElementById('dates').value = ext.dates;
    if(ext.adjustments) document.getElementById('adjustments').value = (ext.adjustments||[]).join(', ');
  }catch(e){
    log(e.message,'err');
    alert(e.message);
  }
});

// 舊作掃描/命名
document.getElementById('btnScanOld').addEventListener('click', async()=>{
  const btn = document.getElementById('btnScanOld');
  const original = btn.textContent;
  btn.disabled = true; btn.classList.add('busy'); btn.textContent = '掃描中…';

  try{
    const title = document.getElementById('workTitle').value.trim();
    if(!title){
      alert('請先輸入作品名稱');
      return;
    }
    log('掃描舊作…');

    const j = await listFilesByKeyword(title);

    const tbody = document.querySelector('#renameTable tbody');
    tbody.innerHTML='';

    (j.files||[]).forEach(f=>{
      // 建立索引（後續 fetchDriveFileText 用）
      DRIVE_FILE_INDEX[f.id] = {
        id: f.id,
        name: f.name,
        mimeType: f.mimeType,
        shortcutDetails: f.shortcutDetails || null
      };

      const guessYear = /20\d{2}/.exec(f.name)?.[0]||'';
      const kind = f.mimeType.includes('folder')? '資料夾':'檔案';
      const ext = f.name.includes('.')? f.name.split('.').pop():'';
      const suggested = `${title}_${guessYear||'YYYY'}_${kind==='資料夾'?'資料':'檔'}_v01${ext?'.'+ext:''}`;

      const tr = document.createElement('tr');
      const checkboxId = `oldpick-${f.id}`;
      tr.innerHTML = `
        <td>
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="${checkboxId}" data-id="${f.id}" />
            <span>${f.name}</span>
            <span class="mini" style="opacity:.7">(${f.mimeType}${f.shortcutDetails?' → '+f.shortcutDetails.targetMimeType:''})</span>
          </label>
        </td>
        <td><input data-id="${f.id}" value="${suggested}"/></td>
        <td class="mini">待執行</td>
      `;
      tr.querySelector('input[type="checkbox"]').addEventListener('change', (e)=>{
        const id = e.target.dataset.id;
        if (e.target.checked) SELECTED_OLD_FILE_IDS.add(id);
        else SELECTED_OLD_FILE_IDS.delete(id);
      });
      tbody.appendChild(tr);
    });

    // 重置搜尋框並套用一次篩選
    const search = document.getElementById('oldSearch');
    if(search){ search.value=''; filterOldList(); }

    log('完成，請檢查命名建議。');
  }catch(e){
    log(e.message,'err');
    alert(e.message);
  }finally{
    btn.textContent = '完成 ✓';
    setTimeout(()=>{ btn.disabled=false; btn.classList.remove('busy'); btn.textContent = original; }, 800);
  }
});

document.getElementById('btnApplyRename').addEventListener('click', async()=>{
  try{
    const rows = document.querySelectorAll('#renameTable tbody tr');
    for(const r of rows){
      const input = r.querySelector('input');
      const id = input.dataset.id;
      const newName = input.value.trim();
      const status = r.querySelector('td:last-child');
      try{
        await gfetch(`${GDRIVE_FILES}/${id}?supportsAllDrives=true`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name: newName })
        });

        status.innerHTML = '<span class="ok">已改名</span>';
      }catch(e){ status.innerHTML = '<span class="err">失敗</span>'; }
    }
    log('批次命名完成。');
  }catch(e){ log(e.message,'err'); }
});

// 佈署
document.getElementById('btnDeploy').addEventListener('click', async()=>{
  const btn = document.getElementById('btnDeploy');
  const original = btn.textContent;
  btn.disabled = true; btn.classList.add('busy'); btn.textContent = '執行中…';

  try{
    const year  = document.getElementById('workYear').value.trim();
    const title = document.getElementById('workTitle').value.trim();
    if(!year||!title) { alert('請先輸入 年度 與 作品名稱'); return; }

    // 1) 建資料夾結構
const root = await findOrCreateFolder(DRIVE_ROOT_NAME);
const { workFolderId, planFolderId } = await ensureFolderTree(root.id, year, title);
log('佈署完成，已建立分層資料夾（不匯入舊作捷徑）。');

// 1.5) 先在「製作/計畫書」底下建立一份空白 Google Doc，取得 URL 先給任務用
const draftDocId = await createDoc(`${title}（${year}）計劃書—草稿`);
CURRENT_DOC_ID = draftDocId;
const planDocUrl = `https://docs.google.com/document/d/${draftDocId}/edit`;

// 2) 準備置換變數（提供給模板）
const workFolderUrl = `https://drive.google.com/drive/folders/${workFolderId}`;
const planFolderUrl = `https://drive.google.com/drive/folders/${planFolderId}`;

// 3) 讀任務模板（先 Sheet，再 JSON）── 把 planDocUrl 一起傳進去
const templates = await loadTaskTemplates({ title, year, workFolderUrl, planFolderUrl, planDocUrl });


    if (!templates.length) {
      log('【提醒】未找到任務模板（請建立名為「劇團計畫-任務模板」的 Sheet，或同名 JSON）。','warn');
    } else {
      // 4) ★強制所有任務都進同一清單：「年度,作品名稱」
      const listName = `${year},${title}`;
      const tasks = templates.map(t => ({
  title: t.title,
  notes: t.notes,
  dueISODate: t.dueISODate,
  links: t.links   // ★把模板裡的 link1/link2 一起送進去
}));


      // 5) 批次建立
      const { created, failed, list } = await createManyTasks({
        listName,
        tasks,
        chunkSize: 25,
        delayMs: 200
      });

      log(`已將 ${created.length} 筆任務建立到清單「${list.title}」；失敗 ${failed.length} 筆。`);
      if (failed.length) log('失敗明細（只印前 3 筆）：\n' + failed.slice(0,3).map(x => `- ${x.input.title}：${x.error}`).join('\n'), 'warn');
    }

    btn.textContent = '完成 ✓';
  }catch(e){
    log(e.message,'err');
    alert(e.message);
  }finally{
    setTimeout(()=>{ btn.disabled=false; btn.classList.remove('busy'); btn.textContent = original; }, 800);
  }
});


// 綁定每段「生成」與「寫入」
const genMap = {
  originGoals: gen_originGoals,
  workDescription: gen_workDescription,
  team: gen_team,
  schedule: gen_schedule,
  tech: gen_tech,
  marketing: gen_marketing,
  budget: gen_budget
};

document.querySelectorAll('[data-gen]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const secKey = btn.dataset.gen;

    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '生成中…';

    try{
      // 讀取建議與現有內容
      const suggestion = (document.getElementById(`sug-${secKey}`)?.value || '').trim();
      const currentTextArea = document.getElementById(`sec-${secKey}`);
      const existing = (currentTextArea?.value || SECTIONS[secKey] || '').trim();

      // 將勾選的舊作抓文字，暫存（供模型參考）
      CURRENT_EXTRA_MINUTES = await gatherSelectedOldTexts(15000);

      let content;

      if (suggestion && !shouldRewrite(suggestion) && existing) {
        // 有建議＋已有內容 → 做「精修 revise」
        log(`依建議微調「${secKey}」…`);
        content = await reviseSection(secKey, existing, suggestion);
      } else {
        // 首次生成 或 明確要求重寫
        const opts = { suggestion };
        log(`生成/重寫「${secKey}」…（含勾選舊作 ${SELECTED_OLD_FILE_IDS.size} 筆）`);
        content = await genMap[secKey](opts);
      }

      // 清掉暫存，避免影響下一次
      CURRENT_EXTRA_MINUTES = '';

      SECTIONS[secKey] = content;
      if(currentTextArea) currentTextArea.value = content;
      log(`完成：${secKey}`);

      btn.textContent = '已生成 ✓';
      setTimeout(()=>{ btn.textContent = originalText; btn.disabled = false; }, 1000);
    }catch(e){
      CURRENT_EXTRA_MINUTES = '';
      log(e.message,'err');
      btn.textContent = originalText;
      btn.disabled = false;
    }
  });
});


document.querySelectorAll('[data-write]').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const secKey = btn.dataset.write;
    try{
      // 以 textarea 內容為準（可以讓你手動修後再寫入）
      SECTIONS[secKey] = document.getElementById(`sec-${secKey}`).value.trim() || SECTIONS[secKey] || '(待補)';
      await writeAllToDoc();
      log(`已將目前各段（含 ${secKey}）寫入 Docs。`);
    }catch(e){ log(e.message,'err'); }
  });
});

document.getElementById('btnWriteDoc').addEventListener('click', async ()=>{
  const btn = document.getElementById('btnWriteDoc');
  const original = btn.textContent;
  btn.disabled = true; btn.classList.add('busy'); btn.textContent = '寫入中…';

  try{
    // 將畫面上每個 textarea 的內容同步到 SECTIONS
    Object.keys(SECTIONS).forEach(k=>{
      const v = (document.getElementById(`sec-${k}`)?.value||'').trim();
      if(v) SECTIONS[k]=v;
    });
    await writeAllToDoc();
    log('已將目前各段整合寫入 Docs。');
    btn.textContent = '完成 ✓';
  }catch(e){
    log(e.message,'err');
    alert(e.message);
  }finally{
    setTimeout(()=>{ btn.disabled=false; btn.classList.remove('busy'); btn.textContent = original; }, 800);
  }
});


async function writeAllToDoc(){
  if(!WORK_FOLDER_ID) return alert('請先執行「建資料夾結構」');
  const title = document.getElementById('workTitle').value.trim();
  const year = document.getElementById('workYear').value.trim();
  const docName = `${title||'未命名'}${year?('_'+year):''}_文化局_計劃書`;

  const full = buildFullDoc();
  if(!CURRENT_DOC_ID){ CURRENT_DOC_ID = await createDoc(docName); }
  await overwriteDoc(CURRENT_DOC_ID, full);
}

// 匯出 PDF
document.getElementById('btnExport').addEventListener('click', async()=>{
  const btn = document.getElementById('btnExport');
  const original = btn.textContent;
  btn.disabled = true; btn.classList.add('busy'); btn.textContent = '匯出中…';

  try{
    if(!CURRENT_DOC_ID) { alert('尚未有 Docs 文件，請先寫入一次。'); return; }
    const title = document.getElementById('workTitle').value.trim();
    const year = document.getElementById('workYear').value.trim();
    const outName = `${title||'未命名'}${year?('_'+year):''}_文化局_計劃書.pdf`;
    const id = await exportDocToPdfAndSave(CURRENT_DOC_ID, outName);
    log(`PDF 已上傳：${outName}（ID: ${id}）`);
    btn.textContent = '完成 ✓';
  }catch(e){
    log(e.message,'err');
    alert(e.message);
  }finally{
    setTimeout(()=>{ btn.disabled=false; btn.classList.remove('busy'); btn.textContent = original; }, 800);
  }
});

// ======= 本機儲存（localStorage）Key 名稱 =======
const LS_KEY_OPENAI = 'mvp1017001_openai_key';
const LS_KEY_GCID   = 'mvp1017001_google_client_id';

// 載入：把 localStorage 的值放回輸入框
function loadLocalSecrets(){
  try{
    const k = localStorage.getItem(LS_KEY_OPENAI) || '';
    const g = localStorage.getItem(LS_KEY_GCID)   || '';
    if (k) document.getElementById('openaiKey').value = k;
    if (g) document.getElementById('googleClientId').value = g;
    if (k || g) log('已從本機載入金鑰/ID。');
  }catch(e){
    log('讀取本機儲存失敗：'+ e.message, 'err');
  }
}

// 儲存：把輸入框的值寫進 localStorage
function saveLocalSecrets(){
  try{
    const k = (document.getElementById('openaiKey')?.value || '').trim();
    const g = (document.getElementById('googleClientId')?.value || '').trim();
    localStorage.setItem(LS_KEY_OPENAI, k);
    localStorage.setItem(LS_KEY_GCID, g);
    log('已儲存到本機（localStorage）。');
    alert('已儲存到本機（此裝置的瀏覽器）。');
  }catch(e){
    log('儲存到本機失敗：'+ e.message, 'err');
    alert('儲存到本機失敗');
  }
}

// 清除：把 localStorage 的兩個值刪掉並清空欄位
function clearLocalSecrets(){
  try{
    localStorage.removeItem(LS_KEY_OPENAI);
    localStorage.removeItem(LS_KEY_GCID);
    const kEl = document.getElementById('openaiKey');
    const gEl = document.getElementById('googleClientId');
    if (kEl) kEl.value = '';
    if (gEl) gEl.value = '';
    log('已清除本機儲存。');
    alert('已清除本機儲存。');
  }catch(e){
    log('清除本機儲存失敗：'+ e.message, 'err');
    alert('清除本機儲存失敗');
  }
}


</script>
</body>
</html>
